<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
    <head>
        <title>Spring Security ACL Plugin 3.0.0.M1</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />
        <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8" />
    <script type="text/javascript">
function addJsClass(el) {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
    </head>

    <body class="body" onload="addJsClass();">
        <div id="navigation">
            <ul>
                <li>
                    <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                        <a href="../guide/index.html" class="button">Table of contents</a>
                        <div id="nav-summary-childs" style="display:none;">
                            
                            <div class="toc-item" style="margin-left:0"><a href="#introduction"><strong>1</strong><span>Introduction to the Spring Security ACL Plugin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#usage"><strong>2</strong><span>Usage</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#tutorial"><strong>3</strong><span>Tutorial</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0"><a href="#sampleApp"><strong>4</strong><span>Sample Application</span></a></div>
                            
                        </div>
                    </div>
                </li>
                <li class="separator selected">
                    <a id="ref-button" onclick="localToggle(); return false;" href="#">Quick Reference</a>
                </li>
            </ul>
        </div>
        <div id="header">
            <div class="images clearfix">
                
                
            </div>
            <p></p>
        </div>


        <table id="colset" border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td id="col1">
                    <div id="main" class="corner-all">

                        <span id='toggle-col1' class="toggle">(<a href="#" onclick="localToggle(); return false;">Quick Reference</a>)</span>

                        <div class="project">
                            <h1>Spring Security ACL Plugin - Reference Documentation</h1>
                            <p><strong>Authors:</strong> Burt Beckwith</p>
                            <p><strong>Version:</strong> 3.0.0.M1</p>
                            
                        </div>

                        
                        <div id="table-of-content">
                            <h2>Table of Contents</h2>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#introduction"><strong>1</strong><span>Introduction to the Spring Security ACL Plugin</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#history"><strong>1.1</strong><span>History</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#usage"><strong>2</strong><span>Usage</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#serviceMethods"><strong>2.1</strong><span>Securing Service Methods</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#acls"><strong>2.2</strong><span>Working with ACLs</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#domainClasses"><strong>2.3</strong><span>Domain Classes</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#configuration"><strong>2.4</strong><span>Configuration</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#runAs"><strong>2.5</strong><span>Run-As Authentication Replacement</span></a></div>
                            
                            <div class="toc-item" style="margin-left:10px"><a href="#customPermissions"><strong>2.6</strong><span>Custom Permissions</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#tutorial"><strong>3</strong><span>Tutorial</span></a></div>
                            
                            <div class="toc-item" style="margin-left:0px"><a href="#sampleApp"><strong>4</strong><span>Sample Application</span></a></div>
                            
                            <div style="clear:both" ></div>
                        </div>
                        
                        

<h1 id="introduction">1 Introduction to the Spring Security ACL Plugin</h1>
The ACL plugin adds Domain Object Security support to a Grails application that uses Spring Security. It depends on the <a href="http://grails.org/plugin/spring-security-core" target="blank">Spring Security Core plugin</a>.<p class="paragraph"/>The core plugin and other extension plugins support restricting access to URLs via rules that include checking a user's authentication status, roles, etc. and the ACL plugin extends this by adding support for restricting access to individual domain class instances. The access can be very fine-grained and can define which actions can be taken on an object - these typically include Read, Create, Write, Delete, and Administer but you're free to define whatever actions you like.<p class="paragraph"/>To learn about using ACLs in Grails, you can follow guide:3. Tutorial and in addition you can download and run a complete Grails application that uses the plugin. Installing and running the application are described guide:4. Sample Application.<p class="paragraph"/>In addition to this document, you should read the Spring Security documentation <a href="http://docs.spring.io/spring-security/site/docs/3.2.x/reference/htmlsingle/#domain-acls" target="blank">here</a>.



<h2 id="history">1.1 History</h2>
<h4>History</h4>
<ul class="star">
<li>August 24, 2015</li>
<ul class="star">
<li>3.0.0.M1 release</li>
</ul>
<li>November 17, 2014</li>
<ul class="star">
<li>2.0-RC2 release</li>
</ul>
<li>October 08, 2013</li>
<ul class="star">
<li>2.0-RC1 release</li>
</ul>
<li>August 20, 2012</li>
<ul class="star">
<li>1.1.1 release</li>
</ul>
<li>February 16, 2011</li>
<ul class="star">
<li>1.1 release</li>
</ul>
<li>February 7, 2011</li>
<ul class="star">
<li>1.0.2 release</li>
</ul>
<li>August 1, 2010</li>
<ul class="star">
<li>1.0.1 release</li>
</ul>
<li>July 27, 2010</li>
<ul class="star">
<li>1.0 release</li>
</ul>
<li>May 22, 2010</li>
<ul class="star">
<li>initial 0.1 release</li>
</ul></ul><p class="paragraph"/><h4>Authors</h4><p class="paragraph"/>Burt Beckwith<p class="paragraph"/><h4>Previous work</h4><p class="paragraph"/>Stephan February did the <a href="http://blog.bruary.net/2008/04/grails-acegi-acl-howto.html" target="blank">first work</a> adding ACL support to the <a href="http://grails.org/plugin/acegi/" target="blank">Acegi</a> plugin. At the time the plugin was based on Acegi 1.0.x and around the same time the plugin was converted to use Spring Security 2.0 and the ACL support wasn't converted to use the new package layout and approach.<p class="paragraph"/>Work was done in 2009 to create a GORM-based implementation (the standard Spring Security implementation uses JDBC). Around the same time, Phillip Merensky <a href="http://grails.1312388.n4.nabble.com/Acegi-Plugin-0-5-1-with-ACL-support-implemented-td1400650.html" target="blank">mentioned on the Grails mailing list</a> that he was working on an implementation. He wrote about his approach <a href="http://imagesiteproject.wordpress.com/2009/09/24/integration-of-spring-security-into-grails-plugin-approach-3/" target="blank">here</a> and this was merged in with the other approach but never formally released.<p class="paragraph"/>This plugin builds on that work but is based on Spring Security 3 and Spring 4.



<h1 id="usage">2 Usage</h1>



<h2 id="serviceMethods">2.1 Securing Service Methods</h2>
There are two primary use cases for ACL security: determining whether a user is allowed to perform an action on an instance before the action is invoked, and restricting access to single or multiple instances after methods are invoked (this is typically implemented by collection filtering). You can call <code>aclUtilService.hasPermission()</code> explicitly, but this tends to clutter your code with security logic that often has little to do with business logic. Instead, Spring Security provides some convenient annotations that are used to wrap your method calls in access checks.<p class="paragraph"/>There are four annotations:
<ul class="star">
<li><a href="http://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/access/prepost/PreAuthorize.html" target="blank">@PreAuthorize</a></li>
<li><a href="http://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/access/prepost/PreFilter.html" target="blank">@PreFilter</a></li>
<li><a href="http://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/access/prepost/PostAuthorize.html" target="blank">@PostAuthorize</a></li>
<li><a href="http://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/access/prepost/PostFilter.html" target="blank">@PostFilter</a></li>
</ul><p class="paragraph"/>The annotations use security-specific Spring expression language (SpEL) expressions - see <a href="http://docs.spring.io/spring-security/site/docs/3.2.x/reference/htmlsingle/#el-access" target="blank">the documentation</a> for the available standard and method expressions.<p class="paragraph"/>Here's an example service that manages a <code>Report</code> domain class and uses these annotations and expressions:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.security.access.prepost.PostFilter
<span class="java&#45;keyword">import</span> org.springframework.security.access.prepost.PreAuthorize
<span class="java&#45;keyword">import</span> org.springframework.transaction.annotation.Transactional<p class="paragraph"/><span class="java&#45;keyword">import</span> com.yourapp.Report<p class="paragraph"/>class ReportService &#123;<p class="paragraph"/>   @PreAuthorize(<span class="java&#45;quote">"hasPermission(&#35;id, 'com.yourapp.Report', read) or "</span> +
                 <span class="java&#45;quote">"hasPermission(&#35;id, 'com.yourapp.Report', admin)"</span>)
   Report getReport(<span class="java&#45;object">long</span> id) &#123;
      Report.get(id)
   &#125;<p class="paragraph"/>   @Transactional
   @PreAuthorize(<span class="java&#45;quote">"hasRole('ROLE_USER')"</span>)
   Report createReport(params) &#123;
      Report report = <span class="java&#45;keyword">new</span> Report(params)
      report.save()
      report
   &#125;<p class="paragraph"/>   @PreAuthorize(<span class="java&#45;quote">"hasRole('ROLE_USER')"</span>)
   @PostFilter(<span class="java&#45;quote">"hasPermission(filterObject, read) or "</span> +
               <span class="java&#45;quote">"hasPermission(filterObject, admin)"</span>)
   List getAllReports(params = &#91;:&#93;) &#123;
      Report.list(params)
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_USER', 'ROLE_ADMIN'&#93;)
   <span class="java&#45;object">String</span> getReportName(<span class="java&#45;object">long</span> id) &#123;
      Report.get(id).name
   &#125;<p class="paragraph"/>   @Transactional
   @PreAuthorize(<span class="java&#45;quote">"hasPermission(&#35;report, write) or "</span> +
                 <span class="java&#45;quote">"hasPermission(&#35;report, admin)"</span>)
   Report updateReport(Report report, params) &#123;
      report.properties = params
      report.save()
      report
   &#125;<p class="paragraph"/>   @Transactional
   @PreAuthorize(<span class="java&#45;quote">"hasPermission(&#35;report, delete) or "</span> +
                 <span class="java&#45;quote">"hasPermission(&#35;report, admin)"</span>)
   void deleteReport(Report report) &#123;
      report.delete()
   &#125;
&#125;</pre></div><p class="paragraph"/>The configuration specifies these rules:
<ul class="star">
<li><code>getReport</code> requires that the authenticated user have <code>BasePermission.READ</code> or <code>BasePermission.ADMIN</code> for the instance</li>
<li><code>createReport</code> requires <code>ROLE_USER</code></li>
<li><code>getAllReports</code> requires <code>ROLE_USER</code> and will have elements removed from the returned <code>List</code> that the user doesn't have an ACL grant for; the user must have <code>BasePermission.READ</code> or <code>BasePermission.ADMIN</code> for each element in the list; elements that don't have access granted will be removed</li>
<li><code>getReportName</code> requires that the authenticated user have either <code>ROLE_USER</code> or <code>ROLE_ADMIN</code> (but no ACL rules)</li>
<li><code>updateReport</code> has no role restrictions but must satisfy the requirements of the <code>aclReportWriteVoter</code> voter (which has the <code>ACL_REPORT_WRITE</code> config attribute), i.e. <code>BasePermission.ADMINISTRATION</code> or <code>BasePermission.WRITE</code></li>
<li><code>deleteReport</code> has no role restrictions but must satisfy the requirements of the <code>aclReportDeleteVoter</code> voter (which has the <code>ACL_REPORT_DELETE</code> config attribute), i.e. <code>BasePermission.ADMINISTRATION</code> or <code>BasePermission.DELETE</code></li>
</ul><p class="paragraph"/>


<h2 id="acls">2.2 Working with ACLs</h2>
<h4>Suggested application changes</h4><p class="paragraph"/>To properly display access denied exceptions (e.g. when a user tries to perform an action but doesn't have a grant authorizing it), you should create a mapping in <code>grails-app/conf/UrlMappings.groovy</code> for error code 403. In addition, it's possible to trigger a <a href="http://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/acls/model/NotFoundException.html" target="blank">NotFoundException</a> which will create an error 500, but should be treated like a 403 error, so you should add mappings for these conditions:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.security.access.AccessDeniedException
<span class="java&#45;keyword">import</span> org.springframework.security.acls.model.NotFoundException<p class="paragraph"/>class UrlMappings &#123;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mappings = &#123;
      <span class="java&#45;quote">"/$controller/$action?/$id?"</span> &#123;&#125;<p class="paragraph"/>      <span class="java&#45;quote">"/"</span>(view:<span class="java&#45;quote">"/index"</span>)<p class="paragraph"/>      <span class="java&#45;quote">"403"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"error403"</span>)
      <span class="java&#45;quote">"500"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"error500"</span>)
      <span class="java&#45;quote">"500"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"error403"</span>,
            exception: AccessDeniedException)
      <span class="java&#45;quote">"500"</span>(controller: <span class="java&#45;quote">"errors"</span>, action: <span class="java&#45;quote">"error403"</span>,
            exception: NotFoundException)
   &#125;
&#125;</pre></div><p class="paragraph"/>These depend on an <code>ErrorsController</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.yourcompany.yourapp<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.annotation.Secured<p class="paragraph"/>@Secured(&#91;'permitAll'&#93;)
class ErrorsController &#123;<p class="paragraph"/>   def error403() &#123;&#125;<p class="paragraph"/>   def error500() &#123;
      render view: '/error'
   &#125;
&#125;</pre></div><p class="paragraph"/>and a <code>grails-app/views/errors/error403.gsp</code> similar to this:<p class="paragraph"/><div class="code"><pre>&#60;html&#62;
&#60;head&#62;
&#60;title&#62;Access denied!&#60;/title&#62;
&#60;meta name='layout' content='main' /&#62;
&#60;/head&#62;<p class="paragraph"/>&#60;body&#62;
&#60;h1&#62;Access Denied&#60;/h1&#62;
&#60;p&#62;We're sorry, but you are not authorized to
   perform the requested operation.&#60;/p&#62;
&#60;/body&#62;
&#60;/html&#62;</pre></div><p class="paragraph"/><h4>actionSubmit</h4><p class="paragraph"/>Grails has a convenient feature where it supports multiple submit actions per form via the <code>&#60;g:actionSubmit&#62;</code> tag. This is done by posting to the <code>index</code> action but with a special parameter that indicates which action to invoke. This is a problem in general for security since any URL rules for edit, delete, save, etc. will be bypassed. It's an even more significant issue with ACLs because of the way that the access denied exception interacts with the <code>actionSubmit</code> processing. If you don't make any adjustments for this, your users will see a blank page when they attempt to submit a form and the action is disallowed. The solution is to remove <code>actionSubmit</code> buttons and replace them with regular submit buttons. This requires one form per button, and without adjusting the CSS the buttons will look differently than if they were in-line <code>actionSubmit</code> buttons, but that is fixable with the appropriate CSS changes.<p class="paragraph"/>It's simple to adjust the <code>actionSubmit</code> buttons and you'll need to change them in <code>show.gsp</code> and <code>edit.gsp</code>; <code>list.gsp</code> and <code>show.gsp</code> don't need any changes. In <code>show.gsp</code>, replace the two actionSubmit buttons with these two forms (maintain the g:message tags; the strings are hard-coded here to reduce clutter):<p class="paragraph"/><div class="code"><pre>&#60;div class=<span class="java&#45;quote">"buttons"</span>&#62;
   &#60;g:form action='edit'&#62;
      &#60;g:hiddenField name=<span class="java&#45;quote">"id"</span> value=<span class="java&#45;quote">"$&#123;reportInstance?.id&#125;"</span> /&#62;
      &#60;span class=<span class="java&#45;quote">"button"</span>&#62;
         &#60;g:submitButton class=<span class="java&#45;quote">"edit"</span> name=<span class="java&#45;quote">"Edit"</span> /&#62;
      &#60;/span&#62;
   &#60;/g:form&#62;
   &#60;g:form action='delete'&#62;
      &#60;g:hiddenField name=<span class="java&#45;quote">"id"</span> value=<span class="java&#45;quote">"$&#123;reportInstance?.id&#125;"</span> /&#62;
      &#60;span class=<span class="java&#45;quote">"button"</span>&#62;
         &#60;g:submitButton class=<span class="java&#45;quote">"delete"</span> name=<span class="java&#45;quote">"Delete"</span>
                         onclick=<span class="java&#45;quote">"<span class="java&#45;keyword">return</span> confirm('Are you sure?');"</span> /&#62;
      &#60;/span&#62;
   &#60;/g:form&#62;
&#60;/div&#62;</pre></div><p class="paragraph"/>In <code>edit.gsp</code>, change the <code>&#60;form&#62;</code> tag to<p class="paragraph"/><div class="code"><pre>&#60;g:form action='update'&#62;</pre></div><p class="paragraph"/>and convert the update button to a regular submit button:<p class="paragraph"/><div class="code"><pre>&#60;div class=<span class="java&#45;quote">"buttons"</span>&#62;
   &#60;span class=<span class="java&#45;quote">"button"</span>&#62;
      &#60;g:submitButton class=<span class="java&#45;quote">"save"</span> name=<span class="java&#45;quote">"Update"</span> /&#62;
   &#60;/span&#62;
&#60;/div&#62;</pre></div><p class="paragraph"/>and move the delete button out of the form into its own form just below the main form:<p class="paragraph"/><div class="code"><pre>&#60;g:form action='delete'&#62;
   &#60;g:hiddenField name=<span class="java&#45;quote">"id"</span> value=<span class="java&#45;quote">"$&#123;reportInstance?.id&#125;"</span> /&#62;
   &#60;div class=<span class="java&#45;quote">"buttons"</span>&#62;
      &#60;span class=<span class="java&#45;quote">"button"</span>&#62;
         &#60;g:submitButton class=<span class="java&#45;quote">"delete"</span> name=<span class="java&#45;quote">"Delete"</span>
                         onclick=<span class="java&#45;quote">"<span class="java&#45;keyword">return</span> confirm('Are you sure?');"</span> /&#62;
      &#60;/span&#62;
   &#60;/div&#62;
&#60;/g:form&#62;</pre></div>



<h2 id="domainClasses">2.3 Domain Classes</h2>
The plugin uses domain classes to manage database state. Ordinarily the database structure isn't all that important, but to be compatible with the traditional JDBC-based Spring Security code, the domain classes are configured to generate the table and column names that are used there.<p class="paragraph"/>The plugin classes related to persistence use these classes, so they're included in the plugin but can be overridden by running the <a href="../ref/Scripts/s2-create-acl-domains.html" class="Scripts">s2-create-acl-domains</a> script.<p class="paragraph"/>As you can see, the database structure is highly normalized.<p class="paragraph"/><h4>AclClass</h4><p class="paragraph"/>The <code>AclClass</code> domain class contains entries for the names of each application domain class that has associated permissions:<p class="paragraph"/><div class="code"><pre>class AclClass &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> className<p class="paragraph"/>   @Override
   <span class="java&#45;object">String</span> toString() &#123;
      <span class="java&#45;quote">"AclClass id $id, className $className"</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      className column: 'class'
      version <span class="java&#45;keyword">false</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      className unique: <span class="java&#45;keyword">true</span>
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>AclSid</h4><p class="paragraph"/>The <code>AclSid</code> domain class contains entries for the names of grant recipients (a principal or authority - SID is an acronym for "security identity"). These are typically usernames (where <code>principal</code> is <code>true</code>) but can also be a <code>GrantedAuthority</code> (role name, where <code>principal</code> is <code>false</code>). When granting permissions to a role, any user with that role receives that permission:<p class="paragraph"/><div class="code"><pre>class AclSid &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> sid
   <span class="java&#45;object">boolean</span> principal<p class="paragraph"/>   @Override
   <span class="java&#45;object">String</span> toString() &#123;
      <span class="java&#45;quote">"AclSid id $id, sid $sid, principal $principal"</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      version <span class="java&#45;keyword">false</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      principal unique: 'sid'
   &#125;
&#125;</pre></div><p class="paragraph"/><h4>AclObjectIdentity</h4><p class="paragraph"/>The <code>AclObjectIdentity</code> domain class contains entries representing individual domain class instances (OIDs). It has a field for the instance id (<code>objectId</code>) and domain class (<code>aclClass</code>) that uniquely identify the instance. In addition there are optional nullable fields for the parent OID (<code>parent</code>) and owner (<code>owner</code>). There's also a flag (<code>entriesInheriting</code>) to indicate whether ACL entries can inherit from a parent ACL.<p class="paragraph"/><div class="code"><pre>class AclObjectIdentity <span class="java&#45;keyword">extends</span> AbstractAclObjectIdentity &#123;<p class="paragraph"/>   <span class="java&#45;object">Long</span> objectId<p class="paragraph"/>   @Override
   <span class="java&#45;object">String</span> toString() &#123;
      <span class="java&#45;quote">"AclObjectIdentity id $id, aclClass $aclClass.className, "</span> +
      <span class="java&#45;quote">"objectId $objectId, entriesInheriting $entriesInheriting"</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      version <span class="java&#45;keyword">false</span>
      aclClass column: 'object_id_class'
      owner column: 'owner_sid'
      parent column: 'parent_object'
      objectId column: 'object_id_identity'
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      objectId unique: 'aclClass'
   &#125;
&#125;</pre></div><p class="paragraph"/><code>AclObjectIdentity</code> actually extends a base class, <code>AbstractAclObjectIdentity</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">abstract</span> class AbstractAclObjectIdentity &#123;<p class="paragraph"/>   AclClass aclClass
   AclObjectIdentity parent
   AclSid owner
   <span class="java&#45;object">boolean</span> entriesInheriting<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      parent nullable: <span class="java&#45;keyword">true</span>
      owner nullable: <span class="java&#45;keyword">true</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>By default it's assumed that domain classes have a numeric primary key, but that's not required. So the default implementation has a <code>Long</code> <code>objectId</code> field, but if you want to support other types of ids you can change that field and retain the other standard functionality from the base class.<p class="paragraph"/><h4>AclEntry</h4><p class="paragraph"/>Finally, the <code>AclEntry</code> domain class contains entries representing grants (or denials) of a permission on an object instance to a recipient. The <code>aclObjectIdentity</code> field references the domain class instance (since an instance can have many granted permissions). The <code>sid</code> field references the recipient. The <code>granting</code> field determines whether the entry grants the permission (<code>true</code>) or denies it (<code>false</code>). The <code>aceOrder</code> field specifies the position of the entry, which is important because the entries are evaluated in order and the first matching entry determines whether access is allowed. <code>auditSuccess</code> and <code>auditFailure</code> determine whether to log success and/or failure events (these both default to <code>false</code>).<p class="paragraph"/>The <code>mask</code> field holds the permission. This can be a source of confusion because the name (and the Spring Security documentation) indicates that it's a bit mask. A value of 1 indicates permission A, a value of 2 indicates permission B, a value of 4 indicates permission C, a value of 8 indicates permission D, etc. So you would think that a value of 5 would indicate a grant of both permission A and C. Unfortunately this is not the case. There is a <a href="http://docs.spring.io/spring-security/site/docs/3.2.x/apidocs/org/springframework/security/acls/domain/CumulativePermission.html" target="blank">CumulativePermission</a> class that supports this, but the standard classes don't support it (<code>AclImpl.isGranted()</code> checks for == rather than using | (bitwise or) so a combined entry would never match). So rather than grouping all permissions for one recipient on one instances into a bit mask, you must create individual records for each. This will be addressed in Spring Security 3.1 however.<p class="paragraph"/><div class="code"><pre>class AclEntry &#123;<p class="paragraph"/>   AclObjectIdentity aclObjectIdentity
   <span class="java&#45;object">int</span> aceOrder
   AclSid sid
   <span class="java&#45;object">int</span> mask
   <span class="java&#45;object">boolean</span> granting
   <span class="java&#45;object">boolean</span> auditSuccess
   <span class="java&#45;object">boolean</span> auditFailure<p class="paragraph"/>   @Override
   <span class="java&#45;object">String</span> toString() &#123;
      <span class="java&#45;quote">"AclEntry id $id, aceOrder $aceOrder, mask $mask, "</span> +
      <span class="java&#45;quote">"granting $granting, aclObjectIdentity $aclObjectIdentity"</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      version <span class="java&#45;keyword">false</span>
      sid column: 'sid'
      aclObjectIdentity column: 'acl_object_identity'
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      aceOrder unique: 'aclObjectIdentity'
   &#125;
&#125;</pre></div>



<h2 id="configuration">2.4 Configuration</h2>
Creating, editing, or deleting permissions requires an authenticated user. In most cases  if the authenticated user is the owner of the ACL then access is allowed, but granted roles also affect whether access is allowed. The default required role is <code>ROLE_ADMIN</code> for all actions, but this can be configured in <code>grails-app/conf/Config.groovy</code>. This table summarizes the attribute names and the corresponding actions that are allowed for it:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Attribute</strong></th><th><strong class="bold">Affected methods</strong></th></tr><tr class="table-odd"><td><code>grails.plugin.springsecurity. acl.authority. modifyAuditingDetails</code></td><td><code>AuditableAcl.updateAuditing()</code></td></tr><tr class="table-even"><td><code>grails.plugin.springsecurity. acl.authority. changeOwnership</code></td><td><code>OwnershipAcl.setOwner()</code></td></tr><tr class="table-odd"><td><code>grails.plugin.springsecurity. acl.authority. changeAclDetails</code></td><td><code>MutableAcl.deleteAce()</code>, <code>MutableAcl.insertAce()</code>, <code>MutableAcl.setEntriesInheriting()</code>, <code>MutableAcl.setParent()</code>, <code>MutableAcl.updateAce()</code></td></tr></table><p class="paragraph"/>You can leave the attributes set to <code>ROLE_ADMIN</code> or change them to have separate values, e.g.<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.acl.authority.
        modifyAuditingDetails = 'ROLE_ACL_MODIFY_AUDITING'<p class="paragraph"/>grails.plugin.springsecurity.acl.authority.
        changeOwnership = 'ROLE_ACL_CHANGE_OWNERSHIP'<p class="paragraph"/>grails.plugin.springsecurity.acl.authority.
        changeAclDetails = 'ROLE_ACL_CHANGE_DETAILS'</pre></div><p class="paragraph"/><h4>Run-As Authentication Replacement</h4><p class="paragraph"/>There are also two options to configure <a href="http://docs.spring.io/spring-security/site/docs/3.2.x/reference/htmlsingle/#runas" target="blank">Run-As Authentication Replacement</a>:<p class="paragraph"/><table class="wiki-table" cellpadding="0" cellspacing="0" border="0"><tr><th><strong class="bold">Attribute</strong></th><th><strong class="bold">Meaning</strong></th></tr><tr class="table-odd"><td><code>grails.plugin.springsecurity. useRunAs</code></td><td>change to <code>true</code> to enable; defaults to <code>false</code></td></tr><tr class="table-even"><td><code>grails.plugin.springsecurity. runAs.key</code></td><td>a shared key between the two standard implementation classes, used to verify that a third party hasn't created a token for the user; should be changed from its default value</td></tr></table><p class="paragraph"/>Example:<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.useRunAs = <span class="java&#45;keyword">true</span>
grails.plugin.springsecurity.runAs.key = 'your run&#45;as key'</pre></div>



<h2 id="runAs">2.5 Run-As Authentication Replacement</h2>
Although not strictly related to ACLs, the plugin implements <a href="http://docs.spring.io/spring-security/site/docs/3.2.x/reference/htmlsingle/#runas" target="blank">Run-As Authentication Replacement</a> since it's related to method security in general. This feature is similar to the Switch User feature of the Spring Security Core plugin, but instead of running as another user until you choose to revert to your original <code>Authentication</code>, the temporary authentication switch only lasts for one method invocation.<p class="paragraph"/>For example, in this service <code>someMethod()</code> requires that the authenticated user have <code>ROLE_ADMIN</code> and will also be granted <code>ROLE_RUN_AS_SUPERUSER</code> for the duration of the method only:<p class="paragraph"/><div class="code"><pre>class SecureService &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN', 'RUN_AS_SUPERUSER'&#93;)
   def someMethod() &#123;
      &#8230;
   &#125;
&#125;</pre></div><p class="paragraph"/>


<h2 id="customPermissions">2.6 Custom Permissions</h2>
By default there are 5 permissions available from the <code>org.springframework.security.acls.domain. BasePermission</code> class: <code>READ</code>, <code>WRITE</code>, <code>CREATE</code>, <code>DELETE</code>, and <code>ADMINISTRATION</code>. You can also add your own permissions if these aren't sufficient.<p class="paragraph"/>The easiest approach is to create a subclass of <code>BasePermission</code> and add your new permissions there. This way you retain the default permissions and can use them if you need. For example, here's a subclass that adds a new <code>APPROVE</code> permission:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.mycompany.myapp;<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.security.acls.domain.BasePermission;
<span class="java&#45;keyword">import</span> org.springframework.security.acls.model.Permission;<p class="paragraph"/><span class="java&#45;keyword">public</span> class MyPermission <span class="java&#45;keyword">extends</span> BasePermission &#123;<p class="paragraph"/>   <span class="java&#45;keyword">public</span> <span class="java&#45;keyword">static</span> <span class="java&#45;keyword">final</span> Permission APPROVE = <span class="java&#45;keyword">new</span> MyPermission(1 &#60;&#60; 5, 'V');<p class="paragraph"/>   <span class="java&#45;keyword">protected</span> MyPermission(<span class="java&#45;object">int</span> mask) &#123;
      <span class="java&#45;keyword">super</span>(mask);
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">protected</span> MyPermission(<span class="java&#45;object">int</span> mask, <span class="java&#45;object">char</span> code) &#123;
      <span class="java&#45;keyword">super</span>(mask, code);
   &#125;
&#125;</pre></div><p class="paragraph"/>It sets the mask value to 32 (1 &#60;&#60; 5) since the values up to 16 are defined in the base class.<p class="paragraph"/>To use your class instead of the default, specify it in with the <code>grails.plugin.springsecurity.acl. permissionClass</code> attribute either as a Class or a String, for example<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.mycompany.myapp.MyPermissions
&#8230;
grails.plugin.springsecurity.acl. permissionClass = MyPermissions</pre></div><p class="paragraph"/>or<p class="paragraph"/><div class="code"><pre>grails.plugin.springsecurity.acl.permissionClass = 'com.mycompany.myapp.MyPermissions'</pre></div><p class="paragraph"/>You can also override the <code>aclPermissionFactory</code> bean in <code>grails-app/conf/spring/resources.groovy</code>, keeping the <code>org.springframework.security.acls.domain. DefaultPermissionFactory</code> class but passing your class as the constructor argument to keep it from defaulting to <code>BasePermission</code>, or do a more complex override to more fully reconfigure the behavior:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.security.acls.domain.DefaultPermissionFactory
<span class="java&#45;keyword">import</span> com.mycompany.myapp.MyPermission<p class="paragraph"/>beans = &#123;
   aclPermissionFactory(DefaultPermissionFactory, MyPermission)
&#125;</pre></div><p class="paragraph"/>Once this is done you can use the permission like any other, specifying its quoted lowercase name in an expression, e.g.<p class="paragraph"/><div class="code"><pre>@PreAuthorize(<span class="java&#45;quote">"hasPermission(&#35;id, 'com.testacl.Report', 'approve')"</span>)
Report get(<span class="java&#45;object">long</span> id) &#123;
   Report.get id
&#125;</pre></div>



<h1 id="tutorial">3 Tutorial</h1>
First create a test application:<p class="paragraph"/><pre class="bq"><code>
$ grails create-app acltest
$ cd acltest</code></pre><p class="paragraph"/>Add a dependency for the plugin by adding it to the <code>dependencies</code> block in build.gradle:<p class="paragraph"/><div class="code"><pre>dependencies &#123;
   &#8230;
   compile 'org.grails.plugins:spring&#45;security&#45;acl:3.0.0.M1'
&#125;</pre></div><p class="paragraph"/>and run the <code>compile</code> command to resolve the dependencies:<p class="paragraph"/><pre class="bq"><code>
$ grails compile</code></pre><p class="paragraph"/>This will transitively install the <a href="http://grails.org/plugin/spring-security-core" target="blank">Spring Security Core</a> plugin, so you'll need to configure that by running the <code>s2-quickstart</code> script:<p class="paragraph"/><pre class="bq"><code>
$ grails s2-quickstart com.testacl User Role</code></pre><p class="paragraph"/>The ACL support uses domain classes and includes them in the JAR file, but to allow customizing them (e.g. to enable Hibernate 2nd-level caching) there's a script that copies the domain classes into your application, <code>s2-create-acl-domains</code>. There's no need to run this script if the default configuration is sufficient.<p class="paragraph"/>Note that you cannot change the domain class names or packages since the plugin references them by name. Grails allows you to override plugin artifacts by creating (or copying and modifying existing) classes with the same name and package in your application.<p class="paragraph"/>For portability, the domain class mappings are configured to generate the same DDL as is required by the standard Spring Security JDBC implementation.<p class="paragraph"/>We'll need a domain class to test with, so create a <code>Report</code> domain class:
<pre class="bq"><code>
$ grails create-domain-class com.testacl.Report</code></pre><p class="paragraph"/>and add a <code>name</code> property for testing:
<div class="code"><pre><span class="java&#45;keyword">package</span> com.testacl<p class="paragraph"/>class Report &#123;
   <span class="java&#45;object">String</span> name
&#125;</pre></div><p class="paragraph"/>Next we'll create a service to test ACLs:
<pre class="bq"><code>
$ grails create-service com.testacl.Report</code></pre><p class="paragraph"/>and add some methods that work with <code>Report</code>s:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testacl<p class="paragraph"/><span class="java&#45;keyword">import</span> <span class="java&#45;keyword">static</span> org.springframework.security.acls.domain.BasePermission.ADMINISTRATION<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.security.access.prepost.PostFilter
<span class="java&#45;keyword">import</span> org.springframework.security.access.prepost.PreAuthorize
<span class="java&#45;keyword">import</span> org.springframework.security.acls.domain.DefaultPermissionFactory
<span class="java&#45;keyword">import</span> org.springframework.security.acls.model.AccessControlEntry
<span class="java&#45;keyword">import</span> org.springframework.security.acls.model.MutableAcl
<span class="java&#45;keyword">import</span> org.springframework.security.acls.model.Permission
<span class="java&#45;keyword">import</span> org.springframework.security.acls.model.Sid<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.compiler.GrailsCompileStatic
<span class="java&#45;keyword">import</span> grails.plugin.springsecurity.SpringSecurityService
<span class="java&#45;keyword">import</span> grails.plugin.springsecurity.acl.AclService
<span class="java&#45;keyword">import</span> grails.plugin.springsecurity.acl.AclUtilService
<span class="java&#45;keyword">import</span> grails.transaction.Transactional<p class="paragraph"/>@GrailsCompileStatic
class ReportService &#123;<p class="paragraph"/>   DefaultPermissionFactory aclPermissionFactory
   AclService aclService
   AclUtilService aclUtilService
   SpringSecurityService springSecurityService<p class="paragraph"/>   void addPermission(Report report, <span class="java&#45;object">String</span> username, <span class="java&#45;object">int</span> permission) &#123;
      addPermission report, username, aclPermissionFactory.buildFromMask(permission)
   &#125;<p class="paragraph"/>   @PreAuthorize('hasPermission(&#35;report, admin)')
   @Transactional
   void addPermission(Report report, <span class="java&#45;object">String</span> username, Permission permission) &#123;
      aclUtilService.addPermission report, username, permission
   &#125;<p class="paragraph"/>   @Transactional
   @PreAuthorize('hasRole(<span class="java&#45;quote">"ROLE_USER"</span>)')
   Report create(<span class="java&#45;object">String</span> name) &#123;
      Report report = <span class="java&#45;keyword">new</span> Report(name: name).save(failOnError: <span class="java&#45;keyword">true</span>)<p class="paragraph"/>      // Grant the current principal administrative permission
      addPermission report, springSecurityService.authentication.name, ADMINISTRATION<p class="paragraph"/>      report
   &#125;<p class="paragraph"/>   @PreAuthorize('hasPermission(&#35;id, <span class="java&#45;quote">"com.testacl.Report"</span>, read) or hasPermission(&#35;id, <span class="java&#45;quote">"com.testacl.Report"</span>, admin)')
   Report get(<span class="java&#45;object">long</span> id) &#123;
      Report.get id
   &#125;<p class="paragraph"/>   @PreAuthorize('hasRole(<span class="java&#45;quote">"ROLE_USER"</span>)')
   @PostFilter('hasPermission(filterObject, read) or hasPermission(filterObject, admin)')
   List&#60;Report&#62; list(Map params) &#123;
      Report.list params
   &#125;<p class="paragraph"/>   <span class="java&#45;object">int</span> count() &#123;
      Report.count()
   &#125;<p class="paragraph"/>   @Transactional
   @PreAuthorize('hasPermission(&#35;report, write) or hasPermission(&#35;report, admin)')
   void update(Report report, <span class="java&#45;object">String</span> name) &#123;
      report.name = name
   &#125;<p class="paragraph"/>   @Transactional
   @PreAuthorize('hasPermission(&#35;report, delete) or hasPermission(&#35;report, admin)')
   void delete(Report report) &#123;
      report.delete()<p class="paragraph"/>      // Delete the ACL information as well
      aclUtilService.deleteAcl report
   &#125;<p class="paragraph"/>   @Transactional
   @PreAuthorize('hasPermission(&#35;report, admin)')
   void deletePermission(Report report, Sid recipient, Permission permission) &#123;
      MutableAcl acl = (MutableAcl)aclUtilService.readAcl(report)<p class="paragraph"/>      // Remove all permissions associated with <span class="java&#45;keyword">this</span> particular
      // recipient (string equality to KISS)
      acl.entries.eachWithIndex &#123; AccessControlEntry entry, <span class="java&#45;object">int</span> i &#45;&#62;
         <span class="java&#45;keyword">if</span> (entry.sid == recipient &#38;&#38; entry.permission == permission) &#123;
            acl.deleteAce i
         &#125;
      &#125;<p class="paragraph"/>      aclService.updateAcl acl
   &#125;
&#125;</pre></div><p class="paragraph"/>The configuration specifies these rules:
<ul class="star">
<li><code>addPermission</code> requires that the authenticated user have admin permission on the report instance to grant a permission to someone else</li>
<li><code>create</code> requires that the authenticated user have <code>ROLE_USER</code></li>
<li><code>get</code> requires that the authenticated user have read or admin permission on the specified Report</li>
<li><code>list</code> requires that the authenticated user have ROLE_USER and read or admin permission on each returned Report; instances that don't have granted permissions will be removed from the returned List</li>
<li><code>count</code> has no restrictions</li>
<li><code>update</code> requires that the authenticated user have write or admin permission on the report instance to edit it</li>
<li><code>delete</code> requires that the authenticated user have delete or admin permission on the report instance to edit it</li>
<li><code>deletePermission</code> requires that the authenticated user have admin permission on the report instance to delete a grant</li>
</ul><p class="paragraph"/>To test this out we'll need some users; create a service to create users and their grants:<p class="paragraph"/><pre class="bq"><code>
$ grails create-service com.testacl.SampleData</code></pre><p class="paragraph"/>and add this code:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testacl<p class="paragraph"/><span class="java&#45;keyword">import</span> <span class="java&#45;keyword">static</span> org.springframework.security.acls.domain.BasePermission.ADMINISTRATION
<span class="java&#45;keyword">import</span> <span class="java&#45;keyword">static</span> org.springframework.security.acls.domain.BasePermission.READ
<span class="java&#45;keyword">import</span> <span class="java&#45;keyword">static</span> org.springframework.security.acls.domain.BasePermission.WRITE<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken
<span class="java&#45;keyword">import</span> org.springframework.security.core.authority.AuthorityUtils
<span class="java&#45;keyword">import</span> org.springframework.security.core.context.SecurityContextHolder as SCH<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.transaction.Transactional<p class="paragraph"/>@Transactional
class SampleDataService &#123;<p class="paragraph"/>   def aclService
   def aclUtilService
   def objectIdentityRetrievalStrategy<p class="paragraph"/>   void createSampleData() &#123;
      createUsers()
      loginAsAdmin()
      grantPermissions()<p class="paragraph"/>      // logout
      SCH.clearContext()
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> void loginAsAdmin() &#123;
      // have to be authenticated as an admin to create ACLs
      SCH.context.authentication = <span class="java&#45;keyword">new</span> UsernamePasswordAuthenticationToken(
         'admin', 'admin123',
         AuthorityUtils.createAuthorityList('ROLE_ADMIN'))
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> void createUsers() &#123;
      def roleAdmin = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_ADMIN').save()
      def roleUser = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_USER').save()<p class="paragraph"/>      3.times &#123;
         <span class="java&#45;object">long</span> id = it + 1
         def user = <span class="java&#45;keyword">new</span> User(<span class="java&#45;quote">"user$id"</span>, <span class="java&#45;quote">"password$id"</span>).save()
         UserRole.create user, roleUser
      &#125;<p class="paragraph"/>      def admin = <span class="java&#45;keyword">new</span> User('admin', 'admin123').save()<p class="paragraph"/>      UserRole.create admin, roleUser
      UserRole.create admin, roleAdmin
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> void grantPermissions() &#123;
      def reports = &#91;&#93;
      100.times &#123;
         <span class="java&#45;object">long</span> id = it + 1
         def report = <span class="java&#45;keyword">new</span> Report(name: <span class="java&#45;quote">"report$id"</span>).save()
         reports &#60;&#60; report
         aclService.createAcl(
                 objectIdentityRetrievalStrategy.getObjectIdentity(report))
      &#125;<p class="paragraph"/>      // grant user 1 admin on 11,12 and read on 1&#45;67
      aclUtilService.addPermission reports&#91;10&#93;, 'user1', ADMINISTRATION
      aclUtilService.addPermission reports&#91;11&#93;, 'user1', ADMINISTRATION
      67.times &#123;
         aclUtilService.addPermission reports&#91;it&#93;, 'user1', READ
      &#125;<p class="paragraph"/>      // grant user 2 read on 1&#45;5, write on 5
      5.times &#123;
         aclUtilService.addPermission reports&#91;it&#93;, 'user2', READ
      &#125;
      aclUtilService.addPermission reports&#91;4&#93;, 'user2', WRITE<p class="paragraph"/>      // user 3 has no grants<p class="paragraph"/>      // grant admin admin on all
      <span class="java&#45;keyword">for</span> (report in reports) &#123;
         aclUtilService.addPermission report, 'admin', ADMINISTRATION
      &#125;<p class="paragraph"/>      // grant user 1 ownership on 1,2 to allow the user to grant
      aclUtilService.changeOwner reports&#91;0&#93;, 'user1'
      aclUtilService.changeOwner reports&#91;1&#93;, 'user1'
   &#125;
&#125;</pre></div><p class="paragraph"/>and configure BootStrap.groovy to call the service at startup:<p class="paragraph"/><div class="code"><pre>class BootStrap &#123;<p class="paragraph"/>   def sampleDataService<p class="paragraph"/>   def init = &#123;
      sampleDataService.createSampleData()
   &#125;
&#125;</pre></div><p class="paragraph"/>To have a UI to test with, let's create a <code>Report</code> controller and GSPs:
<pre class="bq"><code>
$ grails generate-all com.testacl.Report</code></pre><p class="paragraph"/>But to use the controller, it will have to be reworked to use <code>ReportService</code>. It's a good idea to put all create/edit/delete code in a transactional service, but in this case we need to move all database access to the service to ensure that appropriate access checks are made:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testacl<p class="paragraph"/><span class="java&#45;keyword">import</span> org.springframework.dao.DataIntegrityViolationException<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.annotation.Secured<p class="paragraph"/>@Secured(&#91;'ROLE_USER'&#93;)
class ReportController &#123;<p class="paragraph"/>   def reportService<p class="paragraph"/>   def index() &#123;
      params.max = <span class="java&#45;object">Math</span>.min(params.max ? params.<span class="java&#45;object">int</span>('max') : 10, 100)
      &#91;reportList: reportService.list(params),
       reportCount: reportService.count()&#93;
   &#125;<p class="paragraph"/>   def create() &#123;
      &#91;report: <span class="java&#45;keyword">new</span> Report(params)&#93;
   &#125;<p class="paragraph"/>   def save() &#123;
      def report = reportService.create(params.name)
      <span class="java&#45;keyword">if</span> (!renderWithErrors('create', report)) &#123;
         redirectShow <span class="java&#45;quote">"Report $report.id created"</span>, report.id
      &#125;
   &#125;<p class="paragraph"/>   def show() &#123;
      def report = findInstance()
      <span class="java&#45;keyword">if</span> (!report) <span class="java&#45;keyword">return</span><p class="paragraph"/>      &#91;report: report&#93;
   &#125;<p class="paragraph"/>   def edit() &#123;
      def report = findInstance()
      <span class="java&#45;keyword">if</span> (!report) <span class="java&#45;keyword">return</span><p class="paragraph"/>      &#91;report: report&#93;
   &#125;<p class="paragraph"/>   def update() &#123;
      def report = findInstance()
      <span class="java&#45;keyword">if</span> (!report) <span class="java&#45;keyword">return</span><p class="paragraph"/>      reportService.update report, params.name
      <span class="java&#45;keyword">if</span> (!renderWithErrors('edit', report)) &#123;
         redirectShow <span class="java&#45;quote">"Report $report.id updated"</span>, report.id
      &#125;
   &#125;<p class="paragraph"/>   def delete() &#123;
      def report = findInstance()
      <span class="java&#45;keyword">if</span> (!report) <span class="java&#45;keyword">return</span><p class="paragraph"/>      <span class="java&#45;keyword">try</span> &#123;
         reportService.delete report
         flash.message = <span class="java&#45;quote">"Report $params.id deleted"</span>
         redirect action: 'list'
      &#125;
      <span class="java&#45;keyword">catch</span> (DataIntegrityViolationException e) &#123;
         redirectShow <span class="java&#45;quote">"Report $params.id could not be deleted"</span>, params.id
      &#125;
   &#125;<p class="paragraph"/>   def grant() &#123;<p class="paragraph"/>      def report = findInstance()
      <span class="java&#45;keyword">if</span> (!report) <span class="java&#45;keyword">return</span><p class="paragraph"/>      <span class="java&#45;keyword">if</span> (!request.post) &#123;
         <span class="java&#45;keyword">return</span> &#91;report: report&#93;
      &#125;<p class="paragraph"/>      reportService.addPermission(report, params.recipient,
              params.<span class="java&#45;object">int</span>('permission'))<p class="paragraph"/>      redirectShow <span class="java&#45;quote">"Permission $params.permission granted on Report $report.id "</span> +
              <span class="java&#45;quote">"to $params.recipient"</span>, report.id
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> Report findInstance() &#123;
      def report = reportService.get(params.<span class="java&#45;object">long</span>('id'))
      <span class="java&#45;keyword">if</span> (!report) &#123;
         flash.message = <span class="java&#45;quote">"Report not found with id $params.id"</span>
         redirect action: 'list'
      &#125;
      report
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> void redirectShow(message, id) &#123;
      flash.message = message
      redirect action: 'show', id: id
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">private</span> <span class="java&#45;object">boolean</span> renderWithErrors(<span class="java&#45;object">String</span> view, Report report) &#123;
      <span class="java&#45;keyword">if</span> (report.hasErrors()) &#123;
         render view: view, model: &#91;report: report&#93;
         <span class="java&#45;keyword">return</span> <span class="java&#45;keyword">true</span>
      &#125;
      <span class="java&#45;keyword">false</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>Note that the controller is annotated to require either <code>ROLE_USER</code> or <code>ROLE_ADMIN</code>. Since services have nothing to do with HTTP, when access is blocked you cannot be redirected to the login page as when you try to access a URL that requires an authentication. So you need to configure URLs with similar role requirements to give the user a chance to attempt a login before calling secured service methods.<p class="paragraph"/>Finally, we'll make a few adjustments so errors are handled gracefully.<p class="paragraph"/>First, edit <code>grails-app/conf/UrlMappings.groovy</code> and add some error code mappings:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.springframework.security.access.AccessDeniedException
<span class="java&#45;keyword">import</span> org.springframework.security.acls.model.NotFoundException<p class="paragraph"/>class UrlMappings &#123;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mappings = &#123;
      <span class="java&#45;quote">"/$controller/$action?/$id?(.$format)?"</span> &#123;&#125;<p class="paragraph"/>      <span class="java&#45;quote">"/"</span>(view: '/index')<p class="paragraph"/>      <span class="java&#45;quote">"403"</span>(controller: 'errors', action: 'error403')
      <span class="java&#45;quote">"404"</span>(controller: 'errors', action: 'error404')
      <span class="java&#45;quote">"500"</span>(controller: 'errors', action: 'error500')
      <span class="java&#45;quote">"500"</span>(controller: 'errors', action: 'error403',
            exception: AccessDeniedException)
      <span class="java&#45;quote">"500"</span>(controller: 'errors', action: 'error403',
            exception: NotFoundException)
   &#125;
&#125;</pre></div><p class="paragraph"/>Then create the <code>ErrorsController</code> that these reference:<p class="paragraph"/><pre class="bq"><code>
$ grails create-controller com.testacl.Errors</code></pre><p class="paragraph"/>and add this code:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.testacl<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugin.springsecurity.annotation.Secured<p class="paragraph"/>@Secured(&#91;'permitAll'&#93;)
class ErrorsController &#123;<p class="paragraph"/>   def error403() &#123;&#125;<p class="paragraph"/>   def error404() &#123;
      render view: '/notFound'
   &#125;<p class="paragraph"/>   def error500() &#123;
      render view: '/error'
   &#125;
&#125;</pre></div><p class="paragraph"/>and we'll need to create the GSP for the `error403` action in <code>grails-app/views/errors/error403.gsp</code>:<p class="paragraph"/><div class="code"><pre>&#60;html&#62;
&#60;head&#62;
&#60;title&#62;Access denied!&#60;/title&#62;
&#60;meta name='layout' content='main' /&#62;
&#60;/head&#62;<p class="paragraph"/>&#60;body&#62;
&#60;h1&#62;Access Denied&#60;/h1&#62;
&#60;p&#62;We're sorry, but you are not authorized
   to perform the requested operation.&#60;/p&#62;
&#60;/body&#62;
&#60;/html&#62;</pre></div><p class="paragraph"/><h4>actionSubmit issues</h4><p class="paragraph"/>Grails has a convenient feature where it supports multiple submit actions per form. This is done by posting to the <code>index</code> action but with a special parameter that indicates which action to invoke. This is a problem in general for security since any URL rules for edit, delete, save, etc. will be bypassed. It's an even more significant issue with ACLs because of the way that the access denied exception interacts with the <code>actionSubmit</code> processing. If you don't make any adjustments for this, your users will see a blank page when they attempt to submit a form and the action is disallowed. The solution is to remove <code>actionSubmit</code> buttons and replace them with regular submit buttons. This requires one form per button, and without adjusting the CSS the buttons will look differently than if they were in-line <code>actionSubmit</code> buttons, but that is fixable with the appropriate CSS changes.<p class="paragraph"/><blockquote class="note">
Note that this is not an issue when using the generated GSPs in Grails 3 because they've been reworked to use the fields plugin, but if you have an older application that you've upgraded or if you have GSPs that don't use the newer approach, you will need to avoid using <code>actionSubmit</code>.
</blockquote><p class="paragraph"/>It's simple to adjust the <code>actionSubmit</code> buttons; in <code>grails-app/views/report/show.gsp</code>, replace the two actionSubmit buttons with these two forms (maintain the g:message tags; the strings are hard-coded here to reduce clutter):<p class="paragraph"/><div class="code"><pre>&#60;div class=<span class="java&#45;quote">"buttons"</span>&#62;
    &#60;g:form action='edit'&#62;
        &#60;g:hiddenField name=<span class="java&#45;quote">"id"</span> value=<span class="java&#45;quote">"$&#123;reportInstance?.id&#125;"</span> /&#62;
        &#60;span class=<span class="java&#45;quote">"button"</span>&#62;
            &#60;g:submitButton class=<span class="java&#45;quote">"edit"</span> name=<span class="java&#45;quote">"Edit"</span> /&#62;
        &#60;/span&#62;
    &#60;/g:form&#62;
    &#60;g:form action='delete'&#62;
        &#60;g:hiddenField name=<span class="java&#45;quote">"id"</span> value=<span class="java&#45;quote">"$&#123;reportInstance?.id&#125;"</span> /&#62;
        &#60;span class=<span class="java&#45;quote">"button"</span>&#62;
            &#60;g:submitButton class=<span class="java&#45;quote">"delete"</span> name=<span class="java&#45;quote">"Delete"</span>
                            onclick=<span class="java&#45;quote">"<span class="java&#45;keyword">return</span> confirm('Are you sure?');"</span> /&#62;
        &#60;/span&#62;
    &#60;/g:form&#62;
&#60;/div&#62;</pre></div><p class="paragraph"/>In <code>grails-app/views/report/edit.gsp</code>, change the <code>&#60;form&#62;</code> tag to<p class="paragraph"/><div class="code"><pre>&#60;g:form action='update'&#62;</pre></div><p class="paragraph"/>and convert the update button to a regular submit button:<p class="paragraph"/><div class="code"><pre>&#60;div class=<span class="java&#45;quote">"buttons"</span>&#62;
    &#60;span class=<span class="java&#45;quote">"button"</span>&#62;&#60;g:submitButton class=<span class="java&#45;quote">"save"</span> name=<span class="java&#45;quote">"Update"</span> /&#62;&#60;/span&#62;
&#60;/div&#62;</pre></div><p class="paragraph"/>and move the delete button out of the form into its own form just below the main form:<p class="paragraph"/><div class="code"><pre>&#60;g:form action='delete'&#62;
    &#60;g:hiddenField name=<span class="java&#45;quote">"id"</span> value=<span class="java&#45;quote">"$&#123;reportInstance?.id&#125;"</span> /&#62;
    &#60;div class=<span class="java&#45;quote">"buttons"</span>&#62;
        &#60;span class=<span class="java&#45;quote">"button"</span>&#62;
            &#60;g:submitButton class=<span class="java&#45;quote">"delete"</span> name=<span class="java&#45;quote">"Delete"</span>
                            onclick=<span class="java&#45;quote">"<span class="java&#45;keyword">return</span> confirm('Are you sure?');"</span> /&#62;
        &#60;/span&#62;
    &#60;/div&#62;
&#60;/g:form&#62;</pre></div><p class="paragraph"/><code>list.gsp</code> and <code>show.gsp</code> are fine as they are.<p class="paragraph"/>Finally, to make it easier to log out (by default POST is required, so typical link that uses GET won't work), add this to <code>grails-app/views/layouts/main.gsp</code> before the <code>&#60;g:layoutBody/&#62;</code> tag:<p class="paragraph"/><div class="code"><pre>&#60;sec:ifLoggedIn&#62;<p class="paragraph"/>&#60;g:form controller='logout'&#62;
   Logged in as &#60;sec:username/&#62; &#45; &#60;g:submitButton name='logout' value='Logout'/&#62;
&#60;/g:form&#62;<p class="paragraph"/>&#60;/sec:ifLoggedIn&#62;
&#60;sec:ifNotLoggedIn&#62;<p class="paragraph"/>&#60;g:link controller='login' action='auth'&#62;Login&#60;/g:link&#62;<p class="paragraph"/>&#60;/sec:ifNotLoggedIn&#62;</pre></div><p class="paragraph"/>and you'll see a link to login if not authenticated, and a button to click to logout if you are.<p class="paragraph"/><h4>Testing</h4><p class="paragraph"/>Now start the app:
<pre class="bq"><code>
$ grails run-app</code></pre><p class="paragraph"/>and open <a href="http://localhost:8080/report" target="blank">http://localhost:8080/report</a><p class="paragraph"/><blockquote class="note">
If you see the error <code>NoSuchMethodError: org.springframework.cache.ehcache.EhCacheFactoryBean.setMaxEntriesLocalHeap(J)V</code> when starting the app, comment out the <code>compile 'org.hibernate:hibernate-ehcache'</code> dependency and disable the second-level cache in <code>application.yml</code> with <code>use_second_level_cache: false</code>, and restart.
</blockquote><p class="paragraph"/>Login as user1/password1 and you should see the first page of results. But if you click on page 7 or higher, you'll see that you can only see a subset of the <code>Report</code>s. This illustrates one issue with using ACLs to restrict view access to instances; you would have to add joins in your query to the ACL database tables to get an accurate count of the total number of visible instances.<p class="paragraph"/>Click on any of the report instance links (e.g. <a href="http://localhost:8080/report/show/63" target="blank">http://localhost:8080/report/show/63</a>) to verify that you can view the instance. You can test that you have no view access to the filtered instances by navigating to <a href="http://localhost:8080/report/show/83" target="blank">http://localhost:8080/report/show/83</a>.<p class="paragraph"/>Verify that user1 has admin permission on report #11 by editing it and deleting it.<p class="paragraph"/>Verify that user1 doesn't have admin permission on report #13 by trying to editing or delete it and you should see the error page when you submit the form.<p class="paragraph"/>Logout (by navigating to <a href="http://localhost:8080/logout" target="blank">http://localhost:8080/logout</a>) and login as user2/password2. You should only see the first five reports. Verify that you can edit #5 but not any of the others, and that you can't delete any.<p class="paragraph"/>Finally. logout and login as admin/admin123. You should be able to view, edit, and delete all instances.



<h1 id="sampleApp">4 Sample Application</h1>
Working with ACLs in Spring Security is complex but it will be easier to understand with a sample application. To help get you started, there's a Grails application that uses the plugin to test with. It's based on the Spring Security <a href="https://github.com/spring-projects/spring-security/tree/master/samples/contacts-xml" target="blank">Contacts</a> sample application. But where the Spring Security application uses SpringMVC, JDBC, etc., this application is 100% Grails. The application is available <a href="https://github.com/burtbeckwith/grails-contacts" target="blank">at GitHub</a>.<p class="paragraph"/>Clone or fork the repo and start the app:<p class="paragraph"/><pre class="bq"><code>
$ grails run-app</code></pre><p class="paragraph"/>Open <a href="http://localhost:8080/" target="blank">http://localhost:8080/</a> in a browser to get started. The main functionality is at <a href="http://localhost:8080/secure" target="blank">http://localhost:8080/secure</a>. The login page lists the various configured users and their passwords; the "rod" user is an admin and has full access and the other users have various grants and ownership.


                    </div>
                </td>
                <td id="col2">
            <div class="local clearfix">
                <div class="local-title">
                    <a href="../guide/index.html" target="mainFrame">Quick Reference</a>
                    <span class="toggle">(<a href="#" onclick="localToggle(); return false;">hide</a>)</span>
                </div>
                <div class="menu">
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">AclUtilService</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/AclUtilService/addPermission.html">addPermission</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/AclUtilService/changeOwner.html">changeOwner</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/AclUtilService/deleteAcl.html">deleteAcl</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/AclUtilService/deletePermission.html">deletePermission</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/AclUtilService/hasPermission.html">hasPermission</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/AclUtilService/readAcl.html">readAcl</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Scripts</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Scripts/s2-create-acl-domains.html">s2-create-acl-domains</a>
                        </div>
                        
                        </div>
                    </div>
                    
                    <div class="menu-block"><h1 class="menu-title" onclick="toggleRef(this.parentNode.childNodes[1])">Tag Libraries</h1><div class="menu-sub">
                        
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/notPermitted.html">notPermitted</a>
                        </div>
                        
                        <div class="menu-item"><a href="../ref/Tag%20Libraries/permitted.html">permitted</a>
                        </div>
                        
                        </div>
                    </div>
                    
                </div>
            </div>
        </td>
            </tr>
        </table>

        <div id="footer">
            
            
        </div>



<script type="text/javascript" src="../js/docs.js"></script>

    </body>
</html>
